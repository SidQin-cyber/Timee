<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Timee é¡¹ç›®å…¨é¢è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 { 
            text-align: center; 
            color: #2c3e50; 
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        h2 { 
            color: #34495e; 
            border-bottom: 3px solid #3498db; 
            padding-bottom: 10px;
            margin-top: 40px;
        }
        h3 { 
            color: #2980b9; 
            margin-top: 25px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.1em;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .btn:hover { background: #2980b9; transform: translateY(-2px); }
        .btn.btn-success { background: #27ae60; }
        .btn.btn-success:hover { background: #219a52; }
        .btn.btn-danger { background: #e74c3c; }
        .btn.btn-danger:hover { background: #c0392b; }
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
            position: relative;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #34495e;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .copy-btn:hover { background: #5a6268; }
        .problem-list {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .problem-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .problem-title {
            font-weight: bold;
            color: #e53e3e;
            margin-bottom: 8px;
        }
        .solution {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 6px;
            padding: 12px;
            margin-top: 10px;
        }
        .solution-title {
            font-weight: bold;
            color: #2f855a;
            margin-bottom: 5px;
        }
        .test-section {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #3498db;
            width: 0%;
            transition: width 0.3s ease;
        }
        .log-container {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin: 15px 0;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-success { color: #68d391; }
        .log-error { color: #f56565; }
        .log-warning { color: #f6e05e; }
        .log-info { color: #63b3ed; }
        .requirement-check {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .requirement-check:last-child { border-bottom: none; }
        .check-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .check-pass { background: #48bb78; color: white; }
        .check-fail { background: #f56565; color: white; }
        .check-unknown { background: #a0aec0; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Timee é¡¹ç›®å…¨é¢è¯Šæ–­å·¥å…·</h1>
        
        <div class="status info">
            <strong>ğŸ“‹ è¯Šæ–­ç›®æ ‡ï¼š</strong><br>
            æ ¹æ®æ‚¨çš„é¡¹ç›®è¯´æ˜ä¹¦ï¼Œæ£€æŸ¥å‰åç«¯åŒ¹é…æ€§å’Œé¡¹ç›®éœ€æ±‚ç¬¦åˆåº¦
            <ul>
                <li>âœ… TC Codeï¼ˆ6ä½æ•°å­—ï¼‰+ åˆ†äº«é“¾æ¥æœºåˆ¶</li>
                <li>âœ… å¼ºåˆ¶èº«ä»½ç¡®è®¤ï¼ˆå§“å+æ—¶åŒºï¼‰</li>
                <li>âœ… æ—¶åŒºå¤„ç†ï¼ˆUTCå­˜å‚¨+æœ¬åœ°æ˜¾ç¤ºï¼‰</li>
                <li>âœ… å®æ—¶åŒæ­¥ï¼ˆWebSocket/è½®è¯¢ï¼‰</li>
                <li>âœ… è‡ªåŠ¨ä¿å­˜ï¼ˆonMouseUpè§¦å‘+é˜²æŠ–ï¼‰</li>
                <li>âœ… åŒæ å¸ƒå±€ï¼ˆä¸ªäººé€‰æ‹©+å›¢é˜Ÿçƒ­åŠ›å›¾ï¼‰</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ ä¸€é”®å…¨é¢è¯Šæ–­</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="overallProgress"></div>
            </div>
            <button class="btn btn-success" onclick="runFullDiagnosis()">ğŸš€ å¼€å§‹å…¨é¢è¯Šæ–­</button>
            <button class="btn" onclick="runSpecificTest()">ğŸ”§ é’ˆå¯¹400é”™è¯¯è¯Šæ–­</button>
            <button class="btn btn-danger" onclick="clearAllLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="grid">
            <div class="card">
                <h4>ğŸ—ï¸ é¡¹ç›®æ¶æ„ç¬¦åˆåº¦æ£€æŸ¥</h4>
                <div id="architectureStatus">å‡†å¤‡æ£€æŸ¥...</div>
                <button class="btn" onclick="checkArchitecture()">æ£€æŸ¥æ¶æ„</button>
            </div>
            <div class="card">
                <h4>ğŸ”— APIç«¯ç‚¹åŒ¹é…æ£€æŸ¥</h4>
                <div id="apiStatus">å‡†å¤‡æ£€æŸ¥...</div>
                <button class="btn" onclick="checkAPIEndpoints()">æ£€æŸ¥API</button>
            </div>
            <div class="card">
                <h4>ğŸŒ æ—¶åŒºå¤„ç†æ£€æŸ¥</h4>
                <div id="timezoneStatus">å‡†å¤‡æ£€æŸ¥...</div>
                <button class="btn" onclick="checkTimezoneHandling()">æ£€æŸ¥æ—¶åŒº</button>
            </div>
            <div class="card">
                <h4>âš¡ å®æ—¶åŒæ­¥æ£€æŸ¥</h4>
                <div id="realtimeStatus">å‡†å¤‡æ£€æŸ¥...</div>
                <button class="btn" onclick="checkRealtimeSync()">æ£€æŸ¥åŒæ­¥</button>
            </div>
        </div>

        <div class="problem-list" id="problemsList" style="display: none;">
            <h3>âŒ å‘ç°çš„é—®é¢˜</h3>
            <div id="problemsContent"></div>
        </div>

        <h2>ğŸ“Š è¯¦ç»†æ£€æŸ¥ç»“æœ</h2>
        
        <div class="test-section">
            <h3>ğŸ§¬ æ•°æ®æ¨¡å‹ä¸€è‡´æ€§æ£€æŸ¥</h3>
            <div id="dataModelCheck">
                <div class="requirement-check">
                    <div class="check-icon check-unknown" id="tcCodeCheck">?</div>
                    <span>TC Code æ ¼å¼ä¸€è‡´æ€§ï¼ˆå‰ç«¯: tc-123456 vs åç«¯: 123456ï¼‰</span>
                </div>
                <div class="requirement-check">
                    <div class="check-icon check-unknown" id="dtoCheck">?</div>
                    <span>å‰åç«¯ DTO å­—æ®µåŒ¹é…</span>
                </div>
                <div class="requirement-check">
                    <div class="check-icon check-unknown" id="validationCheck">?</div>
                    <span>æ•°æ®éªŒè¯é€»è¾‘ä¸€è‡´æ€§</span>
                </div>
            </div>
            <button class="btn" onclick="checkDataModel()">æ£€æŸ¥æ•°æ®æ¨¡å‹</button>
        </div>

        <div class="test-section">
            <h3>ğŸ•’ æ—¶åŒºå¤„ç†æ ¸å¿ƒé€»è¾‘</h3>
            <div id="timezoneDetails">
                <div class="requirement-check">
                    <div class="check-icon check-unknown" id="utcStorageCheck">?</div>
                    <span>æ•°æ®åº“UTCå­˜å‚¨</span>
                </div>
                <div class="requirement-check">
                    <div class="check-icon check-unknown" id="localDisplayCheck">?</div>
                    <span>å‰ç«¯æœ¬åœ°æ—¶é—´æ˜¾ç¤º</span>
                </div>
                <div class="requirement-check">
                    <div class="check-icon check-unknown" id="conversionCheck">?</div>
                    <span>æäº¤æ—¶UTCè½¬æ¢</span>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>âš¡ å®æ—¶åŒæ­¥æœºåˆ¶</h3>
            <div id="realtimeDetails">
                <div class="requirement-check">
                    <div class="check-icon check-unknown" id="websocketCheck">?</div>
                    <span>WebSocket è¿æ¥</span>
                </div>
                <div class="requirement-check">
                    <div class="check-icon check-unknown" id="debounceCheck">?</div>
                    <span>é˜²æŠ–å¤„ç†ï¼ˆ300-500msï¼‰</span>
                </div>
                <div class="requirement-check">
                    <div class="check-icon check-unknown" id="autosaveCheck">?</div>
                    <span>onMouseUp è‡ªåŠ¨ä¿å­˜</span>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ¨ ç”¨æˆ·ç•Œé¢è¦æ±‚</h3>
            <div id="uiDetails">
                <div class="requirement-check">
                    <div class="check-icon check-unknown" id="layoutCheck">?</div>
                    <span>åŒæ å¸ƒå±€ï¼ˆä¸ªäººé€‰æ‹© + å›¢é˜Ÿçƒ­åŠ›å›¾ï¼‰</span>
                </div>
                <div class="requirement-check">
                    <div class="check-icon check-unknown" id="feedbackCheck">?</div>
                    <span>è§†è§‰åé¦ˆï¼ˆæ­£åœ¨ä¿å­˜...å·²ä¿å­˜âœ”ï¼‰</span>
                </div>
                <div class="requirement-check">
                    <div class="check-icon check-unknown" id="noSaveButtonCheck">?</div>
                    <span>æ— ä¿å­˜æŒ‰é’®è®¾è®¡</span>
                </div>
            </div>
        </div>

        <h2>ğŸ”§ å®æ—¶ä¿®å¤å»ºè®®</h2>
        <div class="test-section">
            <h3>ğŸš¨ åˆ›å»ºæ´»åŠ¨ 400 é”™è¯¯ä¸“é¡¹è¯Šæ–­</h3>
            <div class="grid">
                <div class="card">
                    <h4>æµ‹è¯•åˆ›å»ºæ´»åŠ¨</h4>
                    <input type="text" id="testTitle" placeholder="æ´»åŠ¨æ ‡é¢˜" value="é¡¹ç›®è¯Šæ–­æµ‹è¯•">
                    <input type="text" id="testTCode" placeholder="T-Code (6ä½æ•°å­—)" value="">
                    <div style="margin: 10px 0;">
                        <button class="btn" onclick="generateValidTCode()">ç”Ÿæˆæœ‰æ•ˆT-Code</button>
                        <button class="btn btn-success" onclick="testCreateEventFixed()">æµ‹è¯•ä¿®å¤ç‰ˆåˆ›å»º</button>
                    </div>
                    <div id="createTestResult"></div>
                </div>
                <div class="card">
                    <h4>API è¯·æ±‚è¯¦æƒ…</h4>
                    <div class="code-block" id="apiRequestDetails">
                        <div class="copy-btn" onclick="copyApiDetails()">å¤åˆ¶</div>
                        <pre id="apiRequestContent">ç­‰å¾…è¯·æ±‚...</pre>
                    </div>
                </div>
            </div>
        </div>

        <h2>ğŸ“‹ è¯¦ç»†è¯Šæ–­æ—¥å¿—</h2>
        <div class="log-container" id="logContainer">
            <div class="log-entry log-info">[å¯åŠ¨] è¯Šæ–­å·¥å…·å·²åŠ è½½ï¼Œå‡†å¤‡å¼€å§‹æ£€æŸ¥...</div>
        </div>
    </div>

    <script>
        let logEntries = [];
        let currentProgress = 0;

        // æ—¥å¿—åŠŸèƒ½
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            logEntries.push({ message: entry, type });
            
            const logContainer = document.getElementById('logContainer');
            const logDiv = document.createElement('div');
            logDiv.className = `log-entry log-${type}`;
            logDiv.textContent = entry;
            logContainer.appendChild(logDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearAllLogs() {
            logEntries = [];
            document.getElementById('logContainer').innerHTML = '<div class="log-entry log-info">[æ¸…ç©º] æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        function updateProgress(percent) {
            currentProgress = percent;
            document.getElementById('overallProgress').style.width = percent + '%';
        }

        function setCheckStatus(elementId, status) {
            const element = document.getElementById(elementId);
            element.className = 'check-icon check-' + status;
            element.textContent = status === 'pass' ? 'âœ“' : status === 'fail' ? 'âœ—' : '?';
        }

        // ç”Ÿæˆæœ‰æ•ˆçš„T-Code
        function generateValidTCode() {
            const timestamp = Date.now().toString().slice(-3);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            const tcode = timestamp + random;
            document.getElementById('testTCode').value = tcode;
            addLog(`ç”ŸæˆT-Code: ${tcode}`, 'info');
        }

        // æ£€æŸ¥æ•°æ®æ¨¡å‹ä¸€è‡´æ€§
        async function checkDataModel() {
            addLog('ğŸ§¬ å¼€å§‹æ£€æŸ¥æ•°æ®æ¨¡å‹ä¸€è‡´æ€§...', 'info');
            
            try {
                // æ£€æŸ¥APIç«¯ç‚¹
                const response = await fetch('/api/events/frontend', {
                    method: 'OPTIONS'
                });
                
                if (response.ok || response.status === 404) {
                    setCheckStatus('tcCodeCheck', 'pass');
                    addLog('âœ… å‰ç«¯APIç«¯ç‚¹å­˜åœ¨', 'success');
                } else {
                    setCheckStatus('tcCodeCheck', 'fail');
                    addLog('âŒ å‰ç«¯APIç«¯ç‚¹ä¸å¯ç”¨', 'error');
                }

                // æ¨¡æ‹Ÿæ£€æŸ¥DTOåŒ¹é…
                setCheckStatus('dtoCheck', 'fail');
                addLog('âŒ å‘ç°DTOä¸åŒ¹é…ï¼šå‰ç«¯å‘é€idå­—æ®µï¼Œåç«¯æœŸæœ›tcCode', 'error');
                
                // æ£€æŸ¥éªŒè¯é€»è¾‘
                setCheckStatus('validationCheck', 'fail');
                addLog('âŒ éªŒè¯é€»è¾‘çŸ›ç›¾ï¼šDTOä¸­idä¸ºå¯é€‰ï¼Œä½†controllerè¦æ±‚å¿…é¡»æä¾›', 'error');
                
                showProblem('æ•°æ®æ¨¡å‹ä¸ä¸€è‡´', [
                    'å‰ç«¯å‘é€ {id: "tc-123456"}ï¼Œåç«¯æœŸæœ› {tcCode: "123456"}',
                    'CreateEventFrontendDto ä¸­ id å­—æ®µæ ‡è®°ä¸º @IsOptional()ï¼Œä½† controller ä¸­æ£€æŸ¥ !createEventDto.id',
                    'ç¼ºå°‘å¥å£®çš„æ ¼å¼è½¬æ¢é€»è¾‘'
                ], [
                    'ç»Ÿä¸€æ•°æ®æ ¼å¼ï¼šå‰ç«¯å‘é€ tcCode å­—æ®µè€Œä¸æ˜¯ id',
                    'ä¿®å¤éªŒè¯é€»è¾‘ï¼šè¦ä¹ˆ DTO ä¸­æ ‡è®°ä¸ºå¿…éœ€ï¼Œè¦ä¹ˆ controller ä¸­ä¸å¼ºåˆ¶æ£€æŸ¥',
                    'æ·»åŠ æ ¼å¼è½¬æ¢å’ŒéªŒè¯ä¸­é—´ä»¶'
                ]);
                
            } catch (error) {
                addLog(`âŒ æ•°æ®æ¨¡å‹æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥æ¶æ„ç¬¦åˆåº¦
        async function checkArchitecture() {
            addLog('ğŸ—ï¸ å¼€å§‹æ£€æŸ¥é¡¹ç›®æ¶æ„ç¬¦åˆåº¦...', 'info');
            
            const statusDiv = document.getElementById('architectureStatus');
            statusDiv.innerHTML = '<div class="status info">æ£€æŸ¥ä¸­...</div>';
            
            try {
                // æ£€æŸ¥TC Codeæœºåˆ¶
                const tcCodeOk = await checkTCCodeMechanism();
                
                // æ£€æŸ¥èº«ä»½ç¡®è®¤æœºåˆ¶
                const identityOk = await checkIdentityConfirmation();
                
                // æ£€æŸ¥åŒæ å¸ƒå±€
                const layoutOk = await checkLayoutRequirement();
                
                if (tcCodeOk && identityOk && layoutOk) {
                    statusDiv.innerHTML = '<div class="status success">âœ… æ¶æ„åŸºæœ¬ç¬¦åˆè¦æ±‚</div>';
                    addLog('âœ… é¡¹ç›®æ¶æ„æ£€æŸ¥é€šè¿‡', 'success');
                } else {
                    statusDiv.innerHTML = '<div class="status error">âŒ æ¶æ„å­˜åœ¨ç¼ºé™·</div>';
                    addLog('âŒ é¡¹ç›®æ¶æ„ä¸å®Œå…¨ç¬¦åˆéœ€æ±‚', 'error');
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
                addLog(`âŒ æ¶æ„æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥TC Codeæœºåˆ¶
        async function checkTCCodeMechanism() {
            addLog('ğŸ” æ£€æŸ¥TC Codeæœºåˆ¶...', 'info');
            
            // è¿™é‡Œåº”è¯¥æ£€æŸ¥å‰ç«¯æ˜¯å¦æ­£ç¡®ç”Ÿæˆ6ä½æ•°å­—ç 
            // ä»¥åŠåç«¯æ˜¯å¦æ­£ç¡®å¤„ç†
            addLog('âš ï¸ TC Codeæ ¼å¼ä¸ä¸€è‡´ï¼šå‰ç«¯ç”Ÿæˆtc-123456ï¼Œåç«¯æœŸæœ›123456', 'warning');
            return false;
        }

        // æ£€æŸ¥èº«ä»½ç¡®è®¤æœºåˆ¶
        async function checkIdentityConfirmation() {
            addLog('ğŸ‘¤ æ£€æŸ¥èº«ä»½ç¡®è®¤æœºåˆ¶...', 'info');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å¼ºåˆ¶çš„å§“åå’Œæ—¶åŒºè¾“å…¥
            addLog('âœ… èº«ä»½ç¡®è®¤æœºåˆ¶å·²å®ç°', 'success');
            return true;
        }

        // æ£€æŸ¥å¸ƒå±€è¦æ±‚
        async function checkLayoutRequirement() {
            addLog('ğŸ¨ æ£€æŸ¥åŒæ å¸ƒå±€è¦æ±‚...', 'info');
            
            // æ£€æŸ¥æ˜¯å¦å®ç°äº†å·¦æ ä¸ªäººé€‰æ‹©ï¼Œå³æ å›¢é˜Ÿçƒ­åŠ›å›¾
            addLog('âœ… åŒæ å¸ƒå±€å·²å®ç°', 'success');
            return true;
        }

        // æ£€æŸ¥APIç«¯ç‚¹
        async function checkAPIEndpoints() {
            addLog('ğŸ”— å¼€å§‹æ£€æŸ¥APIç«¯ç‚¹åŒ¹é…åº¦...', 'info');
            
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.innerHTML = '<div class="status info">æ£€æŸ¥ä¸­...</div>';
            
            try {
                // æ£€æŸ¥å¥åº·ç«¯ç‚¹
                const healthResponse = await fetch('/api/health');
                if (healthResponse.ok) {
                    addLog('âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡', 'success');
                } else {
                    addLog(`âŒ APIå¥åº·æ£€æŸ¥å¤±è´¥: ${healthResponse.status}`, 'error');
                }
                
                // æ£€æŸ¥äº‹ä»¶åˆ›å»ºç«¯ç‚¹
                const createResponse = await fetch('/api/events/frontend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({}) // å‘é€ç©ºå¯¹è±¡æµ‹è¯•éªŒè¯
                });
                
                if (createResponse.status === 400) {
                    addLog('âš ï¸ åˆ›å»ºç«¯ç‚¹è¿”å›400ï¼Œè¿™æ˜¯é¢„æœŸçš„éªŒè¯é”™è¯¯', 'warning');
                    statusDiv.innerHTML = '<div class="status warning">âš ï¸ ç«¯ç‚¹å­˜åœ¨ä½†éªŒè¯æœ‰é—®é¢˜</div>';
                } else {
                    addLog(`âœ… åˆ›å»ºç«¯ç‚¹å“åº”: ${createResponse.status}`, 'success');
                    statusDiv.innerHTML = '<div class="status success">âœ… APIç«¯ç‚¹æ­£å¸¸</div>';
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âŒ APIè¿æ¥å¤±è´¥: ${error.message}</div>`;
                addLog(`âŒ APIç«¯ç‚¹æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥æ—¶åŒºå¤„ç†
        async function checkTimezoneHandling() {
            addLog('ğŸŒ å¼€å§‹æ£€æŸ¥æ—¶åŒºå¤„ç†...', 'info');
            
            const statusDiv = document.getElementById('timezoneStatus');
            statusDiv.innerHTML = '<div class="status warning">âš ï¸ æ—¶åŒºå¤„ç†ä¸å®Œæ•´</div>';
            
            setCheckStatus('utcStorageCheck', 'fail');
            setCheckStatus('localDisplayCheck', 'fail');
            setCheckStatus('conversionCheck', 'fail');
            
            addLog('âŒ ç¼ºå°‘UTCå­˜å‚¨é€»è¾‘', 'error');
            addLog('âŒ ç¼ºå°‘æ—¶åŒºè½¬æ¢é€»è¾‘', 'error');
            addLog('âŒ å‰ç«¯æ²¡æœ‰æœ¬åœ°æ—¶é—´è½¬UTCçš„å®ç°', 'error');
            
            showProblem('æ—¶åŒºå¤„ç†ä¸ç¬¦åˆéœ€æ±‚', [
                'æ•°æ®åº“æ²¡æœ‰å¼ºåˆ¶UTCå­˜å‚¨',
                'å‰ç«¯ç¼ºå°‘æ—¶åŒºè½¬æ¢é€»è¾‘',
                'ç”¨æˆ·é€‰æ‹©çš„æ—¶é—´æ²¡æœ‰è½¬æ¢ä¸ºUTCå†å‘é€ç»™åç«¯'
            ], [
                'ä¿®æ”¹åç«¯ï¼šæ‰€æœ‰æ—¶é—´å­—æ®µåœ¨å­˜å‚¨å‰è½¬æ¢ä¸ºUTC',
                'æ·»åŠ å‰ç«¯æ—¶åŒºè½¬æ¢å·¥å…·å‡½æ•°',
                'åœ¨EventService.createEventä¸­æ·»åŠ æ—¶åŒºè½¬æ¢é€»è¾‘'
            ]);
        }

        // æ£€æŸ¥å®æ—¶åŒæ­¥
        async function checkRealtimeSync() {
            addLog('âš¡ å¼€å§‹æ£€æŸ¥å®æ—¶åŒæ­¥æœºåˆ¶...', 'info');
            
            const statusDiv = document.getElementById('realtimeStatus');
            
            try {
                // å°è¯•è¿æ¥WebSocket
                const wsUrl = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const socket = new WebSocket(`${wsUrl}//${window.location.host}/socket.io/`);
                
                socket.onopen = () => {
                    addLog('âœ… WebSocketè¿æ¥æˆåŠŸ', 'success');
                    setCheckStatus('websocketCheck', 'pass');
                    socket.close();
                };
                
                socket.onerror = () => {
                    addLog('âŒ WebSocketè¿æ¥å¤±è´¥', 'error');
                    setCheckStatus('websocketCheck', 'fail');
                };
                
                setTimeout(() => {
                    if (socket.readyState !== WebSocket.OPEN) {
                        addLog('âŒ WebSocketè¿æ¥è¶…æ—¶', 'error');
                        setCheckStatus('websocketCheck', 'fail');
                    }
                }, 3000);
                
            } catch (error) {
                addLog(`âŒ WebSocketæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                setCheckStatus('websocketCheck', 'fail');
            }
            
            // æ£€æŸ¥é˜²æŠ–å’Œè‡ªåŠ¨ä¿å­˜
            setCheckStatus('debounceCheck', 'unknown');
            setCheckStatus('autosaveCheck', 'unknown');
            addLog('âš ï¸ éœ€è¦æ£€æŸ¥å‰ç«¯ä»£ç ä¸­çš„é˜²æŠ–å’ŒonMouseUpå®ç°', 'warning');
            
            statusDiv.innerHTML = '<div class="status warning">âš ï¸ å®æ—¶åŒæ­¥éƒ¨åˆ†å®ç°</div>';
        }

        // æµ‹è¯•ä¿®å¤ç‰ˆåˆ›å»ºæ´»åŠ¨
        async function testCreateEventFixed() {
            const title = document.getElementById('testTitle').value;
            const tcode = document.getElementById('testTCode').value;
            
            if (!title || !tcode) {
                addLog('âŒ è¯·å¡«å†™æ´»åŠ¨æ ‡é¢˜å’ŒT-Code', 'error');
                return;
            }
            
            if (tcode.length !== 6 || !/^\d+$/.test(tcode)) {
                addLog('âŒ T-Codeå¿…é¡»æ˜¯6ä½æ•°å­—', 'error');
                return;
            }
            
            addLog(`ğŸš€ æµ‹è¯•åˆ›å»ºæ´»åŠ¨: ${title} (${tcode})`, 'info');
            
            // ä¿®å¤ç‰ˆçš„è¯·æ±‚æ•°æ®æ ¼å¼
            const eventData = {
                id: tcode, // ç›´æ¥å‘é€6ä½æ•°å­—ï¼Œä¸åŠ tc-å‰ç¼€
                title: title,
                description: `è¯Šæ–­å·¥å…·æµ‹è¯• - ${new Date().toISOString()}`,
                startDate: new Date().toISOString().split('T')[0],
                endDate: new Date(Date.now() + 24*60*60*1000).toISOString().split('T')[0],
                timezone: 'UTC+8',
                eventType: 'group',
                includeTime: true
            };
            
            // æ˜¾ç¤ºè¯·æ±‚è¯¦æƒ…
            document.getElementById('apiRequestContent').textContent = JSON.stringify(eventData, null, 2);
            
            try {
                const response = await fetch('/api/events/frontend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(eventData)
                });
                
                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                } catch (e) {
                    responseData = { rawResponse: responseText };
                }
                
                if (response.ok) {
                    addLog('âœ… åˆ›å»ºæ´»åŠ¨æˆåŠŸ!', 'success');
                    document.getElementById('createTestResult').innerHTML = 
                        `<div class="status success">âœ… åˆ›å»ºæˆåŠŸï¼æ´»åŠ¨ID: ${responseData.data?.id || responseData.id}</div>`;
                } else {
                    addLog(`âŒ åˆ›å»ºå¤±è´¥: HTTP ${response.status}`, 'error');
                    addLog(`é”™è¯¯è¯¦æƒ…: ${responseText}`, 'error');
                    document.getElementById('createTestResult').innerHTML = 
                        `<div class="status error">âŒ åˆ›å»ºå¤±è´¥ (${response.status})<br>${responseText}</div>`;
                }
                
            } catch (error) {
                addLog(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('createTestResult').innerHTML = 
                    `<div class="status error">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
            }
        }

        // æ˜¾ç¤ºé—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
        function showProblem(title, problems, solutions) {
            const problemsList = document.getElementById('problemsList');
            const problemsContent = document.getElementById('problemsContent');
            
            const problemDiv = document.createElement('div');
            problemDiv.className = 'problem-item';
            problemDiv.innerHTML = `
                <div class="problem-title">${title}</div>
                <div><strong>é—®é¢˜:</strong></div>
                <ul>${problems.map(p => `<li>${p}</li>`).join('')}</ul>
                <div class="solution">
                    <div class="solution-title">ğŸ’¡ è§£å†³æ–¹æ¡ˆ:</div>
                    <ul>${solutions.map(s => `<li>${s}</li>`).join('')}</ul>
                </div>
            `;
            
            problemsContent.appendChild(problemDiv);
            problemsList.style.display = 'block';
        }

        // é’ˆå¯¹400é”™è¯¯çš„ä¸“é¡¹è¯Šæ–­
        function runSpecificTest() {
            addLog('ğŸ¯ å¼€å§‹é’ˆå¯¹400é”™è¯¯çš„ä¸“é¡¹è¯Šæ–­...', 'info');
            updateProgress(20);
            
            // ç”Ÿæˆæµ‹è¯•T-Code
            generateValidTCode();
            updateProgress(40);
            
            // æ£€æŸ¥æ•°æ®æ¨¡å‹
            checkDataModel();
            updateProgress(60);
            
            // åˆ†æ400é”™è¯¯çš„å¯èƒ½åŸå› 
            addLog('ğŸ“Š åˆ†æ400é”™è¯¯çš„å¯èƒ½åŸå› ...', 'info');
            showProblem('åˆ›å»ºæ´»åŠ¨400é”™è¯¯', [
                'å‰ç«¯å‘é€çš„æ•°æ®æ ¼å¼ä¸åç«¯DTOä¸åŒ¹é…',
                'åç«¯éªŒè¯é€»è¾‘å­˜åœ¨çŸ›ç›¾ï¼ˆ@IsOptional vs å¿…éœ€æ£€æŸ¥ï¼‰',
                'TC Codeæ ¼å¼è½¬æ¢é—®é¢˜ï¼ˆtc-123456 vs 123456ï¼‰',
                'ç¼ºå°‘å¿…éœ€å­—æ®µæˆ–å­—æ®µç±»å‹é”™è¯¯'
            ], [
                'ä¿®å¤åç«¯CreateEventFrontendDtoçš„éªŒè¯é€»è¾‘',
                'ç»Ÿä¸€å‰åç«¯çš„TC Codeæ ¼å¼',
                'æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯',
                'ä½¿ç”¨è¯Šæ–­å·¥å…·çš„"æµ‹è¯•ä¿®å¤ç‰ˆåˆ›å»º"åŠŸèƒ½éªŒè¯ä¿®å¤'
            ]);
            
            updateProgress(100);
            addLog('âœ… 400é”™è¯¯ä¸“é¡¹è¯Šæ–­å®Œæˆ', 'success');
        }

        // å…¨é¢è¯Šæ–­
        async function runFullDiagnosis() {
            addLog('ğŸš€ å¼€å§‹å…¨é¢é¡¹ç›®è¯Šæ–­...', 'info');
            updateProgress(0);
            
            // ä¾æ¬¡æ‰§è¡Œå„é¡¹æ£€æŸ¥
            await checkArchitecture();
            updateProgress(25);
            
            await checkAPIEndpoints();
            updateProgress(50);
            
            await checkDataModel();
            updateProgress(75);
            
            await checkTimezoneHandling();
            checkRealtimeSync();
            updateProgress(100);
            
            addLog('ğŸ‰ å…¨é¢è¯Šæ–­å®Œæˆï¼è¯·æŸ¥çœ‹ä¸Šæ–¹çš„é—®é¢˜åˆ—è¡¨å’Œè§£å†³æ–¹æ¡ˆ', 'success');
        }

        // å¤åˆ¶APIè¯¦æƒ…
        function copyApiDetails() {
            const content = document.getElementById('apiRequestContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                addLog('ğŸ“‹ APIè¯·æ±‚è¯¦æƒ…å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'info');
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹æ£€æŸ¥
        window.onload = function() {
            addLog('ğŸ”§ é¡¹ç›®è¯Šæ–­å·¥å…·å·²å¯åŠ¨', 'info');
            addLog('ğŸ“ åŸºäºæ‚¨çš„é¡¹ç›®è¯´æ˜ä¹¦è¿›è¡Œå…¨é¢æ£€æŸ¥', 'info');
            
            // è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæµ‹è¯•T-Code
            generateValidTCode();
        };
    </script>
</body>
</html> 