# å®Œæ•´çš„Timeeåº”ç”¨ç”Ÿäº§é•œåƒ
FROM node:18-alpine AS base

# å®‰è£…å¿…è¦çš„å·¥å…·
RUN apk add --no-cache curl postgresql-client

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶æ•´ä¸ªé¡¹ç›®
COPY . .

# å®‰è£…åç«¯ä¾èµ–
WORKDIR /app/timee-api
RUN npm ci

# ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
RUN npx prisma generate

# æ„å»ºåç«¯
RUN npm run build

# å®‰è£…å‰ç«¯ä¾èµ–
WORKDIR /app/timee-frontend
RUN npm ci

# æ„å»ºå‰ç«¯
RUN npm run build

# å¤åˆ¶æ„å»ºç»“æœåˆ°æ­£ç¡®ä½ç½®
WORKDIR /app/timee-api
RUN cp -r ../timee-frontend/apps/web/dist/* public/

# å¤åˆ¶ä»£ç†æœåŠ¡å™¨é…ç½®
WORKDIR /app
RUN cp proxy-server-simple.js timee-api/

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/sh' > /app/start-app.sh && \
    echo 'set -e' >> /app/start-app.sh && \
    echo 'echo "ğŸš€ Starting Timee Application"' >> /app/start-app.sh && \
    echo 'cd /app/timee-api' >> /app/start-app.sh && \
    echo 'echo "ğŸ“¡ Starting backend API on port 3000..."' >> /app/start-app.sh && \
    echo 'npm start &' >> /app/start-app.sh && \
    echo 'sleep 5' >> /app/start-app.sh && \
    echo 'echo "ğŸ”— Starting proxy server on port 8080..."' >> /app/start-app.sh && \
    echo 'node proxy-server-simple.js &' >> /app/start-app.sh && \
    echo 'wait' >> /app/start-app.sh

RUN chmod +x /app/start-app.sh

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/api/health || exit 1

# å¯åŠ¨åº”ç”¨
CMD ["/app/start-app.sh"] 