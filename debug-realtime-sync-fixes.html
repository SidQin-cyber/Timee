<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶åŒæ­¥ä¿®å¤éªŒè¯ - Timee Debug</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            border-bottom: 3px solid #dbeafe;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }
        .test-section h2 {
            color: #1f2937;
            margin-top: 0;
        }
        .bug-description {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .bug-description h3 {
            color: #dc2626;
            margin-top: 0;
        }
        .fix-description {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .fix-description h3 {
            color: #16a34a;
            margin-top: 0;
        }
        .test-steps {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .test-steps h3 {
            color: #2563eb;
            margin-top: 0;
        }
        .test-steps ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .test-steps li {
            margin: 8px 0;
            line-height: 1.6;
        }
        .api-test {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
            margin: 5px;
        }
        .status.success { background: #dcfce7; color: #166534; }
        .status.error { background: #fef2f2; color: #dc2626; }
        .status.warning { background: #fef3c7; color: #92400e; }
        .status.info { background: #dbeafe; color: #1d4ed8; }
        .links {
            margin: 20px 0;
            padding: 15px;
            background: #f1f5f9;
            border-radius: 6px;
        }
        .links a {
            display: inline-block;
            margin: 5px 10px 5px 0;
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: 500;
        }
        .links a:hover {
            background: #2563eb;
        }
        .code-block {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .highlight {
            background: #fef3c7;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ å®æ—¶åŒæ­¥ä¿®å¤éªŒè¯ - Timee Debug</h1>
        
        <div class="links">
            <strong>å¿«é€Ÿé“¾æ¥ï¼š</strong>
            <a href="http://localhost:8080/tc-realtime-test" target="_blank">æµ‹è¯•æ´»åŠ¨é¡µé¢</a>
            <a href="http://localhost:8080/tc-realtime-test?debug=1" target="_blank">è°ƒè¯•æ¨¡å¼</a>
            <a href="http://localhost:3000/api/events/tc-realtime-test" target="_blank">APIæ•°æ®</a>
        </div>

        <!-- Bug #1: åŒç”¨æˆ·å®æ—¶åŒæ­¥å¤±è´¥ -->
        <div class="test-section">
            <h2>ğŸ› Bug #1: åŒç”¨æˆ·å®æ—¶åŒæ­¥å¤±è´¥</h2>
            
            <div class="bug-description">
                <h3>é—®é¢˜æè¿°</h3>
                <p><strong>åœºæ™¯ï¼š</strong>æˆ¿é—´é‡Œæ°å¥½æœ‰ä¸¤ä¸ªç”¨æˆ·ï¼ˆç”¨æˆ·Aå’Œç”¨æˆ·Bï¼‰</p>
                <p><strong>æ“ä½œï¼š</strong>ç”¨æˆ·Aåœ¨å·¦ä¾§é€‰æ‹©æ—¶é—´æ®µï¼Œæ•°æ®æˆåŠŸæäº¤åˆ°æœåŠ¡å™¨</p>
                <p><strong>é”™è¯¯è¡¨ç°ï¼š</strong></p>
                <ul>
                    <li>ç”¨æˆ·Aè‡ªå·±çš„å³ä¾§çƒ­åŠ›å›¾æ­£ç¡®æ›´æ–°</li>
                    <li>ç”¨æˆ·Bçš„ç•Œé¢æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œå³ä¾§çƒ­åŠ›å›¾ä¾ç„¶ç©ºç™½</li>
                    <li>åªæœ‰å½“ç”¨æˆ·Aé€€å‡ºæˆ–ç¬¬ä¸‰äººåŠ å…¥æ—¶ï¼Œç”¨æˆ·Bæ‰èƒ½çœ‹åˆ°æ›´æ–°</li>
                </ul>
            </div>

            <div class="fix-description">
                <h3>ä¿®å¤æ–¹æ¡ˆ</h3>
                <p><strong>æ ¹æœ¬åŸå› ï¼š</strong>WebSocketäº‹ä»¶å¤„ç†ä¸ä¸€è‡´</p>
                <ul>
                    <li><span class="highlight">response-created/updated</span> äº‹ä»¶è°ƒç”¨ <code>refreshUserResponses()</code> ä½†æ²¡æœ‰è§¦å‘UIæ›´æ–°</li>
                    <li><span class="highlight">participants-updated</span> äº‹ä»¶ç›´æ¥è°ƒç”¨ <code>set()</code> è§¦å‘Reacté‡æ–°æ¸²æŸ“</li>
                </ul>
                <p><strong>ä¿®å¤æ–¹æ³•ï¼š</strong>è®© <code>refreshUserResponses()</code> ç›´æ¥æ›´æ–°çŠ¶æ€å¹¶é‡æ–°è®¡ç®—çƒ­åŠ›å›¾</p>
            </div>

            <div class="test-steps">
                <h3>æµ‹è¯•æ­¥éª¤</h3>
                <ol>
                    <li>æ‰“å¼€ä¸¤ä¸ªæµè§ˆå™¨çª—å£ï¼ˆæˆ–æ— ç—•æ¨¡å¼ï¼‰</li>
                    <li>éƒ½è®¿é—®: <code>http://localhost:8080/tc-realtime-test</code></li>
                    <li>ç¬¬ä¸€ä¸ªçª—å£ä»¥ <strong>"ç”¨æˆ·A"</strong> èº«ä»½ç™»å½•</li>
                    <li>ç¬¬äºŒä¸ªçª—å£ä»¥ <strong>"ç”¨æˆ·B"</strong> èº«ä»½ç™»å½•</li>
                    <li>åœ¨ç”¨æˆ·Açš„å·¦ä¾§æ—¶é—´ç½‘æ ¼ä¸­é€‰æ‹©ä¸€ä¸ªæ—¶é—´æ®µ</li>
                    <li>è§‚å¯Ÿç”¨æˆ·Bçš„å³ä¾§çƒ­åŠ›å›¾æ˜¯å¦<strong>ç«‹å³æ›´æ–°</strong></li>
                    <li>âœ… ä¿®å¤æˆåŠŸï¼šç”¨æˆ·Båº”è¯¥åœ¨1ç§’å†…çœ‹åˆ°çƒ­åŠ›å›¾æ›´æ–°</li>
                </ol>
            </div>
        </div>

        <!-- Bug #2: æ•°æ®æ¢å¤å’ŒUIæŸå -->
        <div class="test-section">
            <h2>ğŸ› Bug #2: æ•°æ®æ¢å¤å’ŒUIæŸå</h2>
            
            <div class="bug-description">
                <h3>é—®é¢˜æè¿°</h3>
                <p><strong>åœºæ™¯ï¼š</strong>ç”¨æˆ·é€‰æ‹©æ—¶é—´ååˆ·æ–°é¡µé¢æˆ–é‡æ–°è¿›å…¥</p>
                <p><strong>é”™è¯¯è¡¨ç°ï¼š</strong></p>
                <ul>
                    <li>å³ä¾§çƒ­åŠ›å›¾æ­£ç¡®æ˜¾ç¤ºèšåˆæ•°æ®</li>
                    <li>å·¦ä¾§"æˆ‘çš„å¯ç”¨æ—¶é—´"ç¼–è¾‘åŒºæ˜¯ç©ºç™½çš„ï¼ˆæ•°æ®æœªæ¢å¤ï¼‰</li>
                    <li>åœ¨ç©ºç™½çš„å·¦ä¾§è¿›è¡Œä»»ä½•æ“ä½œåï¼Œå³ä¾§çƒ­åŠ›å›¾æŸåï¼Œæ˜¾ç¤º"å…¨é€‰"çŠ¶æ€</li>
                </ul>
            </div>

            <div class="fix-description">
                <h3>ä¿®å¤æ–¹æ¡ˆ</h3>
                <p><strong>æ ¹æœ¬åŸå› ï¼š</strong>æ•°æ®æ¢å¤æ—¶åºé—®é¢˜</p>
                <ul>
                    <li><code>initCurrentUser</code> æ¢å¤äº† <code>localSelection</code> ä½†UIç»„ä»¶æœªåŒæ­¥</li>
                    <li><code>timeGrid.syncWithExternalData</code> ä¾èµ–æ•°æ®å¯èƒ½åœ¨åˆå§‹åŒ–æ—¶æœªå‡†å¤‡å¥½</li>
                </ul>
                <p><strong>ä¿®å¤æ–¹æ³•ï¼š</strong></p>
                <ul>
                    <li>æ·»åŠ å»¶è¿ŸåŒæ­¥æœºåˆ¶ï¼Œç¡®ä¿UIç»„ä»¶å®Œå…¨åˆå§‹åŒ–</li>
                    <li>å¢å¼ºæ•°æ®æ¢å¤çš„æ—¶åºæ§åˆ¶</li>
                    <li>æ·»åŠ é¢å¤–çš„åŒæ­¥è§¦å‘å™¨</li>
                </ul>
            </div>

            <div class="test-steps">
                <h3>æµ‹è¯•æ­¥éª¤</h3>
                <ol>
                    <li>è®¿é—®: <code>http://localhost:8080/tc-realtime-test</code></li>
                    <li>ä»¥ä»»æ„ç”¨æˆ·åç™»å½•ï¼ˆå¦‚ <strong>"æµ‹è¯•ç”¨æˆ·"</strong>ï¼‰</li>
                    <li>åœ¨å·¦ä¾§æ—¶é—´ç½‘æ ¼ä¸­é€‰æ‹©å‡ ä¸ªæ—¶é—´æ®µ</li>
                    <li>ç­‰å¾…æ•°æ®è‡ªåŠ¨ä¿å­˜ï¼ˆ300msåï¼‰</li>
                    <li>åˆ·æ–°é¡µé¢ï¼ˆF5ï¼‰</li>
                    <li>é‡æ–°ä»¥ç›¸åŒç”¨æˆ·åç™»å½•</li>
                    <li>âœ… ä¿®å¤æˆåŠŸæ£€æŸ¥ï¼š
                        <ul>
                            <li>å·¦ä¾§ç¼–è¾‘åŒºåº”è¯¥æ˜¾ç¤ºä¹‹å‰é€‰æ‹©çš„æ—¶é—´æ®µ</li>
                            <li>å³ä¾§çƒ­åŠ›å›¾åº”è¯¥æ­£ç¡®æ˜¾ç¤ºèšåˆæ•°æ®</li>
                            <li>åœ¨å·¦ä¾§è¿›è¡Œæ–°çš„æ“ä½œä¸åº”è¯¥å¯¼è‡´å³ä¾§æ˜¾ç¤º"å…¨é€‰"</li>
                        </ul>
                    </li>
                </ol>
            </div>
        </div>

        <!-- APIæµ‹è¯• -->
        <div class="test-section">
            <h2>ğŸ” APIå’Œæ•°æ®éªŒè¯</h2>
            
            <div class="api-test">
                <h3>æ£€æŸ¥åç«¯æ•°æ®</h3>
                <p>curl http://localhost:3000/api/events/tc-realtime-test/responses</p>
                <p>curl http://localhost:3000/api/events/tc-realtime-test</p>
            </div>

            <div class="test-steps">
                <h3>éªŒè¯æ­¥éª¤</h3>
                <ol>
                    <li>åœ¨æµè§ˆå™¨ä¸­è®¿é—®: <code>http://localhost:3000/api/events/tc-realtime-test/responses</code></li>
                    <li>æ£€æŸ¥æ˜¯å¦èƒ½çœ‹åˆ°ç”¨æˆ·çš„é€‰æ‹©æ•°æ®</li>
                    <li>éªŒè¯æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®</li>
                    <li>ç¡®è®¤WebSocketè¿æ¥çŠ¶æ€ï¼ˆåœ¨æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹ï¼‰</li>
                </ol>
            </div>
        </div>

        <!-- ä¿®å¤ä»£ç æ‘˜è¦ -->
        <div class="test-section">
            <h2>ğŸ› ï¸ ä¿®å¤ä»£ç æ‘˜è¦</h2>
            
            <div class="fix-description">
                <h3>ä¿®å¤ç‚¹1: refreshUserResponseså‡½æ•°</h3>
                <div class="code-block">
// ä¿®å¤å‰ï¼šåªæ›´æ–°æ•°æ®ï¼Œä¸è§¦å‘UIæ›´æ–°
set({ userResponses })
get().calculateHeatmap()

// ä¿®å¤åï¼šç›´æ¥æ›´æ–°çŠ¶æ€ï¼Œç¡®ä¿è§¦å‘Reacté‡æ–°æ¸²æŸ“
const heatmapData = calculateHeatmapData(userResponses, currentEvent)
set({ 
  userResponses, 
  heatmapData,
  lastDataFetch: Date.now() 
})
                </div>
            </div>

            <div class="fix-description">
                <h3>ä¿®å¤ç‚¹2: initCurrentUserå‡½æ•°</h3>
                <div class="code-block">
// æ–°å¢ï¼šå»¶è¿ŸåŒæ­¥æœºåˆ¶
if (existingUserResponse && existingUserResponse.availability.length > 0) {
  setTimeout(() => {
    const { currentUser: latestUser } = get()
    if (latestUser && latestUser.localSelection.length > 0) {
      get().updateLocalSelection(latestUser.localSelection, latestUser.paintMode)
    }
  }, 200) // ç¡®ä¿UIç»„ä»¶å®Œå…¨åˆå§‹åŒ–
}
                </div>
            </div>

            <div class="fix-description">
                <h3>ä¿®å¤ç‚¹3: EventPageé¢å¤–åŒæ­¥</h3>
                <div class="code-block">
// æ–°å¢ï¼šé¢å¤–çš„æ•°æ®æ¢å¤åŒæ­¥æœºåˆ¶
useEffect(() => {
  if (currentUser && currentUser.localSelection.length > 0 && currentEvent?.includeTime) {
    setTimeout(() => {
      timeGrid.syncWithExternalData(currentUser.localSelection)
    }, 100)
  }
}, [currentUser?.userName, currentUser?.localSelection?.length, currentEvent?.includeTime])
                </div>
            </div>
        </div>

        <!-- é¢„æœŸç»“æœ -->
        <div class="test-section">
            <h2>âœ… é¢„æœŸä¿®å¤ç»“æœ</h2>
            
            <div class="status success">Bug #1 ä¿®å¤ï¼šåŒç”¨æˆ·å®æ—¶åŒæ­¥æ­£å¸¸</div>
            <div class="status success">Bug #2 ä¿®å¤ï¼šæ•°æ®æ¢å¤å’ŒUIä¸€è‡´æ€§</div>
            
            <ul>
                <li>âœ… ä¸¤ä¸ªç”¨æˆ·åœ¨åŒä¸€æˆ¿é—´æ—¶ï¼Œé€‰æ‹©æ“ä½œèƒ½ç«‹å³åŒæ­¥</li>
                <li>âœ… åˆ·æ–°é¡µé¢åï¼Œå·¦ä¾§ç¼–è¾‘åŒºæ­£ç¡®æ¢å¤ä¹‹å‰çš„é€‰æ‹©</li>
                <li>âœ… æ•°æ®æ¢å¤åè¿›è¡Œæ–°æ“ä½œä¸ä¼šå¯¼è‡´UIæŸå</li>
                <li>âœ… çƒ­åŠ›å›¾è®¡ç®—å‡†ç¡®ï¼Œä¸ä¼šå‡ºç°"å…¨é€‰"é”™è¯¯</li>
                <li>âœ… WebSocketäº‹ä»¶å¤„ç†ä¸€è‡´ï¼ŒUIæ›´æ–°åŠæ—¶</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>ğŸ¯ å…³é”®æµ‹è¯•åœºæ™¯</h2>
            
            <div class="test-steps">
                <h3>åœºæ™¯1: åŒç”¨æˆ·å®æ—¶åŒæ­¥</h3>
                <ol>
                    <li>ä¸¤ä¸ªæµè§ˆå™¨çª—å£ï¼Œä¸åŒç”¨æˆ·å</li>
                    <li>ç”¨æˆ·Aé€‰æ‹©æ—¶é—´ï¼Œç”¨æˆ·Bç«‹å³çœ‹åˆ°æ›´æ–°</li>
                    <li>ç”¨æˆ·Bé€‰æ‹©æ—¶é—´ï¼Œç”¨æˆ·Aç«‹å³çœ‹åˆ°æ›´æ–°</li>
                    <li>éªŒè¯çƒ­åŠ›å›¾è®¡ç®—æ­£ç¡®</li>
                </ol>
            </div>

            <div class="test-steps">
                <h3>åœºæ™¯2: æ•°æ®æ¢å¤æµ‹è¯•</h3>
                <ol>
                    <li>ç”¨æˆ·é€‰æ‹©æ—¶é—´æ®µå¹¶ä¿å­˜</li>
                    <li>åˆ·æ–°é¡µé¢</li>
                    <li>é‡æ–°ç™»å½•ç›¸åŒç”¨æˆ·å</li>
                    <li>éªŒè¯å·¦ä¾§ç¼–è¾‘åŒºæ­£ç¡®æ¢å¤</li>
                    <li>è¿›è¡Œæ–°çš„é€‰æ‹©æ“ä½œ</li>
                    <li>éªŒè¯å³ä¾§çƒ­åŠ›å›¾ä¸ä¼šæŸå</li>
                </ol>
            </div>
        </div>

    </div>

    <script>
        // è‡ªåŠ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            const statusElements = document.querySelectorAll('.status');
            
            try {
                // æ£€æŸ¥å‰ç«¯
                const frontendResponse = await fetch('http://localhost:8080/');
                if (frontendResponse.ok) {
                    console.log('âœ… å‰ç«¯æœåŠ¡æ­£å¸¸');
                }
                
                // æ£€æŸ¥åç«¯API
                const backendResponse = await fetch('http://localhost:3000/api/events/tc-realtime-test');
                if (backendResponse.ok) {
                    console.log('âœ… åç«¯APIæ­£å¸¸');
                }
                
                // æ£€æŸ¥æµ‹è¯•æ´»åŠ¨
                const eventData = await backendResponse.json();
                console.log('ğŸ“Š æµ‹è¯•æ´»åŠ¨æ•°æ®:', eventData);
                
            } catch (error) {
                console.error('âŒ ç³»ç»Ÿæ£€æŸ¥å¤±è´¥:', error);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', checkSystemStatus);
        
        // æ·»åŠ å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                location.reload();
            }
        });
    </script>
</body>
</html> 