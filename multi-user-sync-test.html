<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç”¨æˆ·åŒæ­¥æµ‹è¯• - çº¦æ—¶é—´</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #1e7e34;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-entry.websocket {
            color: #007bff;
        }
        .log-entry.api {
            color: #28a745;
        }
        .log-entry.error {
            color: #dc3545;
        }
        .log-entry.warning {
            color: #ffc107;
        }
        .user-simulation {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .user-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        .user-card.active {
            border-color: #007bff;
            background: #e7f3ff;
        }
        .time-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            margin-top: 15px;
        }
        .time-slot {
            padding: 8px 4px;
            text-align: center;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .time-slot:hover {
            background: #e9ecef;
        }
        .time-slot.selected {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }
        .time-slot.other-user {
            background: #28a745;
            color: white;
            border-color: #1e7e34;
        }
        .time-slot.overlap {
            background: #ffc107;
            color: #212529;
            border-color: #e0a800;
        }
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }
        .status-indicator.connected {
            background: #28a745;
        }
        .status-indicator.connecting {
            background: #ffc107;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª å¤šç”¨æˆ·åŒæ­¥æµ‹è¯•</h1>
            <p>æµ‹è¯•ä¸åŒç”¨æˆ·é€‰æ‹©æ—¶é—´æ—¶çš„å®æ—¶æ˜¾ç¤ºåŒæ­¥</p>
        </div>

        <!-- æµ‹è¯•é…ç½® -->
        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•é…ç½®</h3>
            <div class="test-controls">
                <div class="input-group" style="width: 200px;">
                    <label>æµ‹è¯•äº‹ä»¶ID:</label>
                    <input type="text" id="eventId" placeholder="tc-123456" value="tc-538518">
                </div>
                <div class="input-group" style="width: 150px;">
                    <label>APIåœ°å€:</label>
                    <input type="text" id="apiUrl" value="https://timee-api.sealoshzh.site">
                </div>
                <div class="input-group" style="width: 150px;">
                    <label>ç”¨æˆ·æ•°é‡:</label>
                    <select id="userCount">
                        <option value="2">2ä¸ªç”¨æˆ·</option>
                        <option value="3">3ä¸ªç”¨æˆ·</option>
                        <option value="4">4ä¸ªç”¨æˆ·</option>
                    </select>
                </div>
            </div>
            <div class="test-controls">
                <button class="btn btn-primary" onclick="initializeTest()">ğŸš€ åˆå§‹åŒ–æµ‹è¯•</button>
                <button class="btn btn-success" onclick="startSyncTest()">â–¶ï¸ å¼€å§‹åŒæ­¥æµ‹è¯•</button>
                <button class="btn btn-warning" onclick="simulateConflict()">âš ï¸ æ¨¡æ‹Ÿå†²çª</button>
                <button class="btn btn-danger" onclick="clearTest()">ğŸ§¹ æ¸…é™¤æµ‹è¯•</button>
            </div>
        </div>

        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="test-section">
            <h3>ğŸ”— è¿æ¥çŠ¶æ€</h3>
            <div class="connection-status">
                <div class="status-indicator" id="wsStatus"></div>
                <span id="wsStatusText">WebSocket: æœªè¿æ¥</span>
                <div class="status-indicator" id="apiStatus"></div>
                <span id="apiStatusText">API: æœªæµ‹è¯•</span>
            </div>
            <div id="connectionInfo" class="status info" style="display: none;">
                ç­‰å¾…è¿æ¥æµ‹è¯•...
            </div>
        </div>

        <!-- ç”¨æˆ·æ¨¡æ‹Ÿ -->
        <div class="test-section">
            <h3>ğŸ‘¥ ç”¨æˆ·æ¨¡æ‹Ÿ</h3>
            <div id="userSimulation" class="user-simulation">
                <!-- ç”¨æˆ·å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- åŒæ­¥æµ‹è¯•ç»“æœ -->
        <div class="test-section">
            <h3>ğŸ“Š åŒæ­¥æµ‹è¯•ç»“æœ</h3>
            <div id="syncResults">
                <div class="status info">ç­‰å¾…å¼€å§‹æµ‹è¯•...</div>
            </div>
        </div>

        <!-- å®æ—¶æ—¥å¿— -->
        <div class="test-section">
            <h3>ğŸ“ å®æ—¶æ—¥å¿—</h3>
            <div class="test-controls">
                <button class="btn btn-warning" onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
                <button class="btn btn-primary" onclick="exportLogs()">å¯¼å‡ºæ—¥å¿—</button>
            </div>
            <div id="logContainer" class="log-container">
                <div class="log-entry info">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let socket = null;
        let currentEventId = null;
        let users = [];
        let testResults = {
            websocketConnected: false,
            apiResponding: false,
            syncWorking: false,
            conflicts: []
        };

        // æ—¥å¿—ç³»ç»Ÿ
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
        }

        function exportLogs() {
            const logs = document.getElementById('logContainer').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `timee-sync-test-${new Date().toISOString().slice(0, 19)}.log`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // WebSocket è¿æ¥ç®¡ç†
        function initializeWebSocket() {
            const apiUrl = document.getElementById('apiUrl').value;
            
            try {
                socket = io(apiUrl, {
                    transports: ['websocket', 'polling'],
                    timeout: 10000,
                    reconnection: true,
                    reconnectionAttempts: 3,
                    reconnectionDelay: 1000,
                });

                socket.on('connect', () => {
                    addLog('âœ… WebSocketè¿æ¥æˆåŠŸ', 'websocket');
                    updateConnectionStatus('ws', 'connected');
                    testResults.websocketConnected = true;
                    
                    if (currentEventId) {
                        socket.emit('join-event', currentEventId);
                        addLog(`ğŸšª åŠ å…¥äº‹ä»¶æˆ¿é—´: ${currentEventId}`, 'websocket');
                    }
                });

                socket.on('disconnect', () => {
                    addLog('âŒ WebSocketè¿æ¥æ–­å¼€', 'error');
                    updateConnectionStatus('ws', 'disconnected');
                    testResults.websocketConnected = false;
                });

                socket.on('connect_error', (error) => {
                    addLog(`âŒ WebSocketè¿æ¥é”™è¯¯: ${error.message}`, 'error');
                    updateConnectionStatus('ws', 'error');
                    testResults.websocketConnected = false;
                });

                // ç›‘å¬å®æ—¶äº‹ä»¶
                socket.on('response_created', (data) => {
                    addLog(`ğŸ“¡ æ”¶åˆ°å“åº”åˆ›å»ºäº‹ä»¶: ${JSON.stringify(data)}`, 'websocket');
                    handleRealtimeUpdate(data);
                });

                socket.on('response_updated', (data) => {
                    addLog(`ğŸ“¡ æ”¶åˆ°å“åº”æ›´æ–°äº‹ä»¶: ${JSON.stringify(data)}`, 'websocket');
                    handleRealtimeUpdate(data);
                });

                socket.on('participants_updated', (data) => {
                    addLog(`ğŸ“¡ æ”¶åˆ°å‚ä¸è€…æ›´æ–°äº‹ä»¶: ${JSON.stringify(data)}`, 'websocket');
                    handleParticipantsUpdate(data);
                });

                socket.on('joined-event', (data) => {
                    addLog(`ğŸšª æˆåŠŸåŠ å…¥äº‹ä»¶æˆ¿é—´: ${JSON.stringify(data)}`, 'websocket');
                });

            } catch (error) {
                addLog(`âŒ WebSocketåˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                updateConnectionStatus('ws', 'error');
            }
        }

        function updateConnectionStatus(type, status) {
            const indicator = document.getElementById(`${type}Status`);
            const text = document.getElementById(`${type}StatusText`);
            
            indicator.className = `status-indicator ${status}`;
            
            if (type === 'ws') {
                switch (status) {
                    case 'connected':
                        text.textContent = 'WebSocket: å·²è¿æ¥';
                        break;
                    case 'connecting':
                        text.textContent = 'WebSocket: è¿æ¥ä¸­';
                        break;
                    case 'disconnected':
                        text.textContent = 'WebSocket: å·²æ–­å¼€';
                        break;
                    case 'error':
                        text.textContent = 'WebSocket: è¿æ¥å¤±è´¥';
                        break;
                }
            } else if (type === 'api') {
                switch (status) {
                    case 'connected':
                        text.textContent = 'API: æ­£å¸¸';
                        break;
                    case 'error':
                        text.textContent = 'API: å¼‚å¸¸';
                        break;
                }
            }
        }

        // API æµ‹è¯•
        async function testAPI() {
            const apiUrl = document.getElementById('apiUrl').value;
            const eventId = document.getElementById('eventId').value;
            
            try {
                updateConnectionStatus('api', 'connecting');
                const response = await fetch(`${apiUrl}/events/${eventId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    addLog(`âœ… APIæµ‹è¯•æˆåŠŸ: äº‹ä»¶ ${eventId} å­˜åœ¨`, 'api');
                    updateConnectionStatus('api', 'connected');
                    testResults.apiResponding = true;
                    return data;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                addLog(`âŒ APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateConnectionStatus('api', 'error');
                testResults.apiResponding = false;
                return null;
            }
        }

        // ç”¨æˆ·æ¨¡æ‹Ÿ
        function createUserSimulation() {
            const userCount = parseInt(document.getElementById('userCount').value);
            const container = document.getElementById('userSimulation');
            
            users = [];
            container.innerHTML = '';
            
            for (let i = 0; i < userCount; i++) {
                const user = {
                    id: i + 1,
                    name: `ç”¨æˆ·${i + 1}`,
                    timezone: 'UTC+8',
                    selections: new Set(),
                    isActive: false
                };
                users.push(user);
                
                const userCard = createUserCard(user);
                container.appendChild(userCard);
            }
            
            addLog(`ğŸ‘¥ åˆ›å»ºäº† ${userCount} ä¸ªæ¨¡æ‹Ÿç”¨æˆ·`, 'info');
        }

        function createUserCard(user) {
            const card = document.createElement('div');
            card.className = 'user-card';
            card.id = `user-${user.id}`;
            
            card.innerHTML = `
                <h4>${user.name}</h4>
                <div class="input-group">
                    <label>æ—¶åŒº:</label>
                    <select onchange="updateUserTimezone(${user.id}, this.value)">
                        <option value="UTC+8">UTC+8 ä¸­å›½æ ‡å‡†æ—¶é—´</option>
                        <option value="UTC+0">UTC+0 è‹±å›½æ—¶é—´</option>
                        <option value="UTC-5">UTC-5 ç¾å›½ä¸œéƒ¨æ—¶é—´</option>
                        <option value="UTC-8">UTC-8 ç¾å›½è¥¿éƒ¨æ—¶é—´</option>
                    </select>
                </div>
                <div class="test-controls">
                    <button class="btn btn-primary" onclick="activateUser(${user.id})">æ¿€æ´»ç”¨æˆ·</button>
                    <button class="btn btn-success" onclick="simulateUserSelection(${user.id})">æ¨¡æ‹Ÿé€‰æ‹©</button>
                    <button class="btn btn-warning" onclick="submitUserData(${user.id})">æäº¤æ•°æ®</button>
                </div>
                <div class="time-grid" id="timeGrid-${user.id}">
                    <!-- æ—¶é—´ç½‘æ ¼å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                </div>
                <div class="status info" id="userStatus-${user.id}">
                    ç­‰å¾…æ¿€æ´»...
                </div>
            `;
            
            generateTimeGrid(user.id);
            return card;
        }

        function generateTimeGrid(userId) {
            const grid = document.getElementById(`timeGrid-${userId}`);
            const times = ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30'];
            
            grid.innerHTML = '';
            times.forEach(time => {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                slot.textContent = time;
                slot.dataset.time = time;
                slot.onclick = () => toggleTimeSlot(userId, time, slot);
                grid.appendChild(slot);
            });
        }

        function toggleTimeSlot(userId, time, element) {
            const user = users.find(u => u.id === userId);
            if (!user || !user.isActive) return;
            
            if (user.selections.has(time)) {
                user.selections.delete(time);
                element.classList.remove('selected');
            } else {
                user.selections.add(time);
                element.classList.add('selected');
            }
            
            updateUserStatus(userId, `é€‰æ‹©äº† ${user.selections.size} ä¸ªæ—¶é—´æ®µ`);
            addLog(`ğŸ‘¤ ${user.name} é€‰æ‹©/å–æ¶ˆé€‰æ‹©æ—¶é—´: ${time}`, 'info');
        }

        function updateUserStatus(userId, message) {
            const status = document.getElementById(`userStatus-${userId}`);
            status.textContent = message;
        }

        function activateUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            // å–æ¶ˆå…¶ä»–ç”¨æˆ·çš„æ¿€æ´»çŠ¶æ€
            users.forEach(u => {
                u.isActive = false;
                document.getElementById(`user-${u.id}`).classList.remove('active');
            });
            
            // æ¿€æ´»å½“å‰ç”¨æˆ·
            user.isActive = true;
            document.getElementById(`user-${userId}`).classList.add('active');
            updateUserStatus(userId, 'å·²æ¿€æ´» - å¯ä»¥é€‰æ‹©æ—¶é—´');
            addLog(`ğŸ‘¤ æ¿€æ´»ç”¨æˆ·: ${user.name}`, 'info');
        }

        function updateUserTimezone(userId, timezone) {
            const user = users.find(u => u.id === userId);
            if (user) {
                user.timezone = timezone;
                addLog(`ğŸŒ ${user.name} æ—¶åŒºæ›´æ–°ä¸º: ${timezone}`, 'info');
            }
        }

        async function simulateUserSelection(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            // éšæœºé€‰æ‹©2-4ä¸ªæ—¶é—´æ®µ
            const times = ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30'];
            const selectCount = Math.floor(Math.random() * 3) + 2;
            
            user.selections.clear();
            
            for (let i = 0; i < selectCount; i++) {
                const randomTime = times[Math.floor(Math.random() * times.length)];
                user.selections.add(randomTime);
            }
            
            // æ›´æ–°UI
            const grid = document.getElementById(`timeGrid-${userId}`);
            const slots = grid.querySelectorAll('.time-slot');
            slots.forEach(slot => {
                const time = slot.dataset.time;
                if (user.selections.has(time)) {
                    slot.classList.add('selected');
                } else {
                    slot.classList.remove('selected');
                }
            });
            
            updateUserStatus(userId, `éšæœºé€‰æ‹©äº† ${user.selections.size} ä¸ªæ—¶é—´æ®µ`);
            addLog(`ğŸ² ${user.name} éšæœºé€‰æ‹©äº† ${selectCount} ä¸ªæ—¶é—´æ®µ`, 'info');
        }

        async function submitUserData(userId) {
            const user = users.find(u => u.id === userId);
            if (!user || user.selections.size === 0) {
                addLog(`âŒ ${user.name} æ²¡æœ‰é€‰æ‹©ä»»ä½•æ—¶é—´æ®µ`, 'warning');
                return;
            }
            
            const apiUrl = document.getElementById('apiUrl').value;
            const eventId = document.getElementById('eventId').value;
            
            // æ„é€ æäº¤æ•°æ®
            const availability = Array.from(user.selections).map(time => ({
                date: '1/1',
                time: time,
                dateIndex: 0,
                timeIndex: 0,
                type: 'available'
            }));
            
            const submitData = {
                eventId: eventId,
                participantName: user.name,
                userInitials: user.name.charAt(0),
                paintMode: 'available',
                timezone: user.timezone,
                availableSlots: availability
            };
            
            try {
                updateUserStatus(userId, 'æäº¤ä¸­...');
                const response = await fetch(`${apiUrl}/responses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(submitData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    updateUserStatus(userId, 'âœ… æäº¤æˆåŠŸ');
                    addLog(`âœ… ${user.name} æ•°æ®æäº¤æˆåŠŸ`, 'api');
                    
                    // ç­‰å¾…ä¸€æ®µæ—¶é—´æ£€æŸ¥åŒæ­¥
                    setTimeout(() => checkSyncStatus(userId), 2000);
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                updateUserStatus(userId, 'âŒ æäº¤å¤±è´¥');
                addLog(`âŒ ${user.name} æ•°æ®æäº¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å®æ—¶æ›´æ–°å¤„ç†
        function handleRealtimeUpdate(data) {
            addLog(`ğŸ“¡ å¤„ç†å®æ—¶æ›´æ–°: ${data.eventId}`, 'websocket');
            testResults.syncWorking = true;
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤šçš„åŒæ­¥éªŒè¯é€»è¾‘
            updateSyncResults();
        }

        function handleParticipantsUpdate(data) {
            addLog(`ğŸ‘¥ å‚ä¸è€…åˆ—è¡¨æ›´æ–°: ${data.count} äºº`, 'websocket');
        }

        // åŒæ­¥çŠ¶æ€æ£€æŸ¥
        async function checkSyncStatus(userId) {
            const apiUrl = document.getElementById('apiUrl').value;
            const eventId = document.getElementById('eventId').value;
            
            try {
                const response = await fetch(`${apiUrl}/responses/event/${eventId}`);
                if (response.ok) {
                    const responses = await response.json();
                    const userResponse = responses.find(r => r.participantName === `ç”¨æˆ·${userId}`);
                    
                    if (userResponse) {
                        addLog(`âœ… ç”¨æˆ·${userId} æ•°æ®åŒæ­¥éªŒè¯æˆåŠŸ`, 'api');
                        updateSyncResults();
                    } else {
                        addLog(`âŒ ç”¨æˆ·${userId} æ•°æ®åŒæ­¥éªŒè¯å¤±è´¥`, 'error');
                    }
                }
            } catch (error) {
                addLog(`âŒ åŒæ­¥çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function updateSyncResults() {
            const container = document.getElementById('syncResults');
            container.innerHTML = `
                <div class="status ${testResults.websocketConnected ? 'success' : 'error'}">
                    WebSocketè¿æ¥: ${testResults.websocketConnected ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}
                </div>
                <div class="status ${testResults.apiResponding ? 'success' : 'error'}">
                    APIå“åº”: ${testResults.apiResponding ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}
                </div>
                <div class="status ${testResults.syncWorking ? 'success' : 'warning'}">
                    å®æ—¶åŒæ­¥: ${testResults.syncWorking ? 'âœ… æ­£å¸¸' : 'âš ï¸ å¾…æµ‹è¯•'}
                </div>
            `;
        }

        // ä¸»è¦æµ‹è¯•å‡½æ•°
        async function initializeTest() {
            currentEventId = document.getElementById('eventId').value;
            
            if (!currentEventId) {
                alert('è¯·è¾“å…¥äº‹ä»¶ID');
                return;
            }
            
            addLog(`ğŸš€ å¼€å§‹åˆå§‹åŒ–æµ‹è¯• - äº‹ä»¶ID: ${currentEventId}`, 'info');
            
            // æµ‹è¯•API
            const eventData = await testAPI();
            if (!eventData) {
                addLog('âŒ APIæµ‹è¯•å¤±è´¥ï¼Œæ— æ³•ç»§ç»­æµ‹è¯•', 'error');
                return;
            }
            
            // åˆå§‹åŒ–WebSocket
            initializeWebSocket();
            
            // åˆ›å»ºç”¨æˆ·æ¨¡æ‹Ÿ
            createUserSimulation();
            
            addLog('âœ… æµ‹è¯•åˆå§‹åŒ–å®Œæˆ', 'info');
        }

        async function startSyncTest() {
            if (!currentEventId) {
                alert('è¯·å…ˆåˆå§‹åŒ–æµ‹è¯•');
                return;
            }
            
            addLog('ğŸ§ª å¼€å§‹åŒæ­¥æµ‹è¯•...', 'info');
            
            // è‡ªåŠ¨æ¿€æ´»ç¬¬ä¸€ä¸ªç”¨æˆ·å¹¶æ¨¡æ‹Ÿé€‰æ‹©
            activateUser(1);
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await simulateUserSelection(1);
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await submitUserData(1);
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // æ¿€æ´»ç¬¬äºŒä¸ªç”¨æˆ·å¹¶æ¨¡æ‹Ÿé€‰æ‹©
            activateUser(2);
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await simulateUserSelection(2);
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await submitUserData(2);
            
            addLog('âœ… åŒæ­¥æµ‹è¯•å®Œæˆ', 'info');
        }

        function simulateConflict() {
            addLog('âš ï¸ æ¨¡æ‹Ÿå†²çªåœºæ™¯...', 'warning');
            
            // è®©æ‰€æœ‰ç”¨æˆ·åŒæ—¶é€‰æ‹©ç›¸åŒçš„æ—¶é—´æ®µ
            users.forEach(user => {
                user.selections.clear();
                user.selections.add('10:00');
                user.selections.add('10:30');
                user.selections.add('11:00');
                
                // æ›´æ–°UI
                const grid = document.getElementById(`timeGrid-${user.id}`);
                const slots = grid.querySelectorAll('.time-slot');
                slots.forEach(slot => {
                    const time = slot.dataset.time;
                    if (user.selections.has(time)) {
                        slot.classList.add('selected');
                    } else {
                        slot.classList.remove('selected');
                    }
                });
            });
            
            addLog('âš ï¸ æ‰€æœ‰ç”¨æˆ·é€‰æ‹©äº†ç›¸åŒçš„æ—¶é—´æ®µï¼Œå‡†å¤‡æµ‹è¯•å¹¶å‘å†²çª', 'warning');
        }

        function clearTest() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            currentEventId = null;
            users = [];
            testResults = {
                websocketConnected: false,
                apiResponding: false,
                syncWorking: false,
                conflicts: []
            };
            
            document.getElementById('userSimulation').innerHTML = '';
            document.getElementById('syncResults').innerHTML = '<div class="status info">ç­‰å¾…å¼€å§‹æµ‹è¯•...</div>';
            
            updateConnectionStatus('ws', 'disconnected');
            updateConnectionStatus('api', 'error');
            
            clearLogs();
            addLog('ğŸ§¹ æµ‹è¯•å·²æ¸…é™¤', 'info');
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            addLog('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•', 'info');
        });
    </script>
</body>
</html> 