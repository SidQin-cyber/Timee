<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 Timee API 错误实时调试工具</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
            border-left: 4px solid;
        }
        .success { 
            background-color: #d4edda; 
            color: #155724; 
            border-color: #28a745; 
        }
        .error { 
            background-color: #f8d7da; 
            color: #721c24; 
            border-color: #dc3545; 
        }
        .warning { 
            background-color: #fff3cd; 
            color: #856404; 
            border-color: #ffc107; 
        }
        .info { 
            background-color: #d1ecf1; 
            color: #0c5460; 
            border-color: #17a2b8; 
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn:hover { 
            background-color: #0056b3; 
            transform: translateY(-1px);
        }
        .btn:active { 
            transform: translateY(0);
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            position: relative;
        }
        .section {
            margin: 30px 0;
            padding: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        h1 { 
            color: #333; 
            text-align: center; 
            margin-bottom: 30px;
        }
        h2 { 
            color: #444; 
            border-bottom: 2px solid #007bff; 
            padding-bottom: 10px; 
            margin-top: 30px;
        }
        h3 { 
            color: #666; 
            margin-top: 25px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .log-container {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-success { color: #68d391; }
        .log-error { color: #f56565; }
        .log-warning { color: #ffa726; }
        .log-info { color: #4299e1; }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ddd;
        }
        .timeline-item {
            position: relative;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #007bff;
            border: 2px solid white;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .copy-btn:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Timee API 错误实时调试工具</h1>
        
        <div class="section">
            <h2>📊 当前状态检测</h2>
            <div class="grid">
                <div class="card">
                    <h3>🌐 访问状态</h3>
                    <div id="accessStatus">检测中...</div>
                    <button class="btn" onclick="detectAccessStatus()">重新检测</button>
                </div>
                <div class="card">
                    <h3>🔗 API 连接</h3>
                    <div id="apiStatus">检测中...</div>
                    <button class="btn" onclick="testAPIConnection()">测试连接</button>
                </div>
                <div class="card">
                    <h3>🎯 创建活动测试</h3>
                    <div id="createEventStatus">准备就绪</div>
                    <button class="btn" onclick="testCreateEvent()">测试创建</button>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>🧪 手动测试创建活动</h2>
            <div class="grid">
                <div class="card">
                    <h3>📝 活动信息</h3>
                    <div class="input-group">
                        <label for="testTitle">活动标题</label>
                        <input type="text" id="testTitle" value="测试活动" placeholder="输入活动标题">
                    </div>
                    <div class="input-group">
                        <label for="testDescription">活动描述</label>
                        <input type="text" id="testDescription" value="API调试测试" placeholder="输入活动描述">
                    </div>
                    <div class="input-group">
                        <label for="testTCode">T-Code (可选)</label>
                        <input type="text" id="testTCode" placeholder="留空自动生成" maxlength="9">
                    </div>
                    <button class="btn btn-success" onclick="manualCreateEvent()">🚀 创建活动</button>
                    <button class="btn" onclick="generateTestTCode()">🎲 生成测试代码</button>
                </div>
                <div class="card">
                    <h3>📋 请求详情</h3>
                    <div id="requestDetails">
                        <div class="code-block">
                            <div class="copy-btn" onclick="copyRequestDetails()">复制</div>
                            <pre id="requestDetailsContent">准备发送请求...</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>📈 调试时间线</h2>
            <div class="timeline" id="debugTimeline">
                <div class="timeline-item">
                    <strong>调试工具已启动</strong>
                    <div>准备开始诊断 API 错误...</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>🔍 详细日志</h2>
            <div style="text-align: right; margin-bottom: 10px;">
                <button class="btn btn-danger" onclick="clearLogs()">清除日志</button>
                <button class="btn" onclick="exportLogs()">导出日志</button>
            </div>
            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">[启动] 调试工具已加载</div>
            </div>
        </div>

        <div class="section">
            <h2>📝 问题报告</h2>
            <div id="problemReport">
                <div class="info">
                    <strong>使用说明：</strong>
                    <ol>
                        <li>点击"重新检测"确认当前访问状态</li>
                        <li>点击"测试连接"验证API连接</li>
                        <li>点击"测试创建"模拟创建活动</li>
                        <li>查看详细日志了解具体错误信息</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script>
        let logs = [];
        let timelineItems = [];

        // 添加日志
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({ message: logEntry, type, timestamp: Date.now() });
            
            const logContainer = document.getElementById('logContainer');
            const logDiv = document.createElement('div');
            logDiv.className = `log-entry log-${type}`;
            logDiv.textContent = logEntry;
            logContainer.appendChild(logDiv);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 添加时间线项目
        function addTimelineItem(title, description, status = 'info') {
            const timeline = document.getElementById('debugTimeline');
            const item = document.createElement('div');
            item.className = 'timeline-item';
            item.innerHTML = `
                <strong>${title}</strong>
                <div>${description}</div>
                <small style="color: #666;">${new Date().toLocaleTimeString()}</small>
            `;
            timeline.appendChild(item);
            timeline.scrollTop = timeline.scrollHeight;
        }

        // 检测访问状态
        function detectAccessStatus() {
            const url = window.location.href;
            const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
            const protocol = window.location.protocol;
            
            addLog(`当前访问地址: ${url}`, 'info');
            addLog(`检测到端口: ${port}`, 'info');
            
            const statusDiv = document.getElementById('accessStatus');
            let statusHTML = '';
            
            if (port === '8080') {
                statusHTML = '<div class="status success">✅ 正确！通过代理端口访问</div>';
                addLog('✅ 端口检测通过 - 使用代理端口8080', 'success');
                addTimelineItem('端口检测', '使用正确的代理端口8080', 'success');
            } else if (port === '5173') {
                statusHTML = '<div class="status error">❌ 错误！直接访问前端端口</div>';
                statusHTML += '<div class="warning">这会导致API请求失败。请访问 <a href="' + url.replace(':5173', ':8080') + '" target="_blank">正确地址</a></div>';
                addLog('❌ 端口检测失败 - 直接访问前端端口5173', 'error');
                addTimelineItem('端口检测', '发现问题：直接访问前端端口5173', 'error');
            } else if (protocol === 'https:') {
                statusHTML = '<div class="status success">✅ 通过HTTPS外部域名访问</div>';
                addLog('✅ 端口检测通过 - 使用HTTPS外部域名', 'success');
                addTimelineItem('端口检测', '使用HTTPS外部域名访问', 'success');
            } else {
                statusHTML = '<div class="status warning">⚠️ 未知端口配置</div>';
                addLog(`⚠️ 检测到未知端口: ${port}`, 'warning');
                addTimelineItem('端口检测', `检测到未知端口: ${port}`, 'warning');
            }
            
            statusDiv.innerHTML = statusHTML;
        }

        // 测试API连接
        async function testAPIConnection() {
            addLog('🔄 开始测试API连接...', 'info');
            addTimelineItem('API连接测试', '开始测试健康检查端点...');
            
            const statusDiv = document.getElementById('apiStatus');
            statusDiv.innerHTML = '<div class="status info">正在测试...</div>';
            
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = '<div class="status success">✅ API连接正常</div>';
                    addLog('✅ API健康检查成功', 'success');
                    addLog(`API响应: ${JSON.stringify(data)}`, 'info');
                    addTimelineItem('API连接测试', 'API健康检查成功', 'success');
                } else {
                    statusDiv.innerHTML = `<div class="status error">❌ API连接失败 (${response.status})</div>`;
                    addLog(`❌ API健康检查失败: HTTP ${response.status}`, 'error');
                    addTimelineItem('API连接测试', `API健康检查失败: HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ API连接失败: ${error.message}</div>`;
                addLog(`❌ API连接错误: ${error.message}`, 'error');
                addTimelineItem('API连接测试', `连接失败: ${error.message}`, 'error');
            }
        }

        // 测试创建活动
        async function testCreateEvent() {
            addLog('🎯 开始测试创建活动...', 'info');
            addTimelineItem('创建活动测试', '开始模拟创建活动...');
            
            const statusDiv = document.getElementById('createEventStatus');
            statusDiv.innerHTML = '<div class="status info">正在测试...</div>';
            
            // 生成测试数据
            const testData = generateTestEventData();
            
            addLog(`测试数据: ${JSON.stringify(testData, null, 2)}`, 'info');
            
            try {
                const response = await fetch('/api/events/frontend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                addLog(`响应状态: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const result = await response.json();
                    statusDiv.innerHTML = '<div class="status success">✅ 创建活动成功！</div>';
                    addLog('✅ 创建活动成功', 'success');
                    addLog(`创建结果: ${JSON.stringify(result, null, 2)}`, 'success');
                    addTimelineItem('创建活动测试', '创建活动成功！', 'success');
                } else {
                    const errorText = await response.text();
                    statusDiv.innerHTML = `<div class="status error">❌ 创建活动失败 (${response.status})</div>`;
                    addLog(`❌ 创建活动失败: HTTP ${response.status}`, 'error');
                    addLog(`错误详情: ${errorText}`, 'error');
                    addTimelineItem('创建活动测试', `创建失败: HTTP ${response.status}`, 'error');
                    
                    // 尝试解析错误信息
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.message) {
                            addLog(`服务器错误信息: ${errorData.message}`, 'error');
                        }
                    } catch (e) {
                        addLog('无法解析错误响应', 'warning');
                    }
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">❌ 创建活动失败: ${error.message}</div>`;
                addLog(`❌ 创建活动错误: ${error.message}`, 'error');
                addTimelineItem('创建活动测试', `网络错误: ${error.message}`, 'error');
            }
        }

        // 生成测试事件数据
        function generateTestEventData() {
            const timestamp = Date.now().toString().slice(-6);
            return {
                id: `tc-${timestamp}`,
                title: '调试测试活动',
                description: '实时调试工具测试',
                startDate: '2024-01-01',
                endDate: '2024-01-02',
                timezone: 'UTC+8',
                eventType: 'group',
                includeTime: true
            };
        }

        // 手动创建活动
        async function manualCreateEvent() {
            const title = document.getElementById('testTitle').value.trim();
            const description = document.getElementById('testDescription').value.trim();
            const tcode = document.getElementById('testTCode').value.trim();
            
            if (!title) {
                addLog('❌ 请输入活动标题', 'error');
                return;
            }
            
            const eventData = {
                id: tcode || `tc-${Date.now().toString().slice(-6)}`,
                title: title,
                description: description,
                startDate: '2024-01-01',
                endDate: '2024-01-02',
                timezone: 'UTC+8',
                eventType: 'group',
                includeTime: true
            };
            
            // 更新请求详情
            document.getElementById('requestDetailsContent').textContent = JSON.stringify(eventData, null, 2);
            
            addLog(`🔄 手动创建活动: ${title}`, 'info');
            addTimelineItem('手动创建活动', `标题: ${title}, T-Code: ${eventData.id}`);
            
            try {
                const response = await fetch('/api/events/frontend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(eventData)
                });
                
                addLog(`响应状态: ${response.status} ${response.statusText}`, 'info');
                
                if (response.ok) {
                    const result = await response.json();
                    addLog('✅ 手动创建活动成功', 'success');
                    addLog(`创建结果: ${JSON.stringify(result, null, 2)}`, 'success');
                    addTimelineItem('手动创建活动', '创建成功！', 'success');
                    
                    // 显示成功信息
                    const reportDiv = document.getElementById('problemReport');
                    reportDiv.innerHTML = `
                        <div class="status success">
                            <strong>🎉 创建成功！</strong><br>
                            活动ID: ${result.data.id}<br>
                            T-Code: ${result.data.tcCode}<br>
                            <a href="/event/${result.data.tcCode}" target="_blank">查看活动</a>
                        </div>
                    `;
                } else {
                    const errorText = await response.text();
                    addLog(`❌ 手动创建活动失败: HTTP ${response.status}`, 'error');
                    addLog(`错误详情: ${errorText}`, 'error');
                    addTimelineItem('手动创建活动', `创建失败: HTTP ${response.status}`, 'error');
                    
                    // 显示错误分析
                    analyzeError(response.status, errorText);
                }
            } catch (error) {
                addLog(`❌ 手动创建活动错误: ${error.message}`, 'error');
                addTimelineItem('手动创建活动', `网络错误: ${error.message}`, 'error');
                analyzeError(0, error.message);
            }
        }

        // 错误分析
        function analyzeError(status, errorText) {
            const reportDiv = document.getElementById('problemReport');
            let analysis = '';
            
            if (status === 400) {
                analysis = `
                    <div class="status error">
                        <strong>❌ 400 错误分析</strong><br>
                        这通常是请求数据格式问题：<br>
                        • 检查T-Code格式是否正确<br>
                        • 确认必填字段是否完整<br>
                        • 验证日期格式是否正确<br>
                        <br>
                        <strong>服务器响应:</strong><br>
                        <div class="code-block">${errorText}</div>
                    </div>
                `;
            } else if (status === 409) {
                analysis = `
                    <div class="status warning">
                        <strong>⚠️ 409 冲突错误</strong><br>
                        T-Code已存在，请尝试：<br>
                        • 使用不同的T-Code<br>
                        • 点击"生成测试代码"获取新代码<br>
                    </div>
                `;
            } else if (status === 0) {
                analysis = `
                    <div class="status error">
                        <strong>❌ 网络连接错误</strong><br>
                        可能的原因：<br>
                        • 端口访问错误<br>
                        • 网络连接问题<br>
                        • 服务器未响应<br>
                        <br>
                        <strong>建议:</strong><br>
                        确认使用正确的访问地址
                    </div>
                `;
            } else {
                analysis = `
                    <div class="status error">
                        <strong>❌ HTTP ${status} 错误</strong><br>
                        <div class="code-block">${errorText}</div>
                    </div>
                `;
            }
            
            reportDiv.innerHTML = analysis;
        }

        // 生成测试T-Code
        function generateTestTCode() {
            const timestamp = Date.now().toString().slice(-6);
            document.getElementById('testTCode').value = `tc-${timestamp}`;
            addLog(`生成测试T-Code: tc-${timestamp}`, 'info');
        }

        // 复制请求详情
        function copyRequestDetails() {
            const content = document.getElementById('requestDetailsContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                addLog('✅ 请求详情已复制到剪贴板', 'success');
            }).catch(err => {
                addLog('❌ 复制失败', 'error');
            });
        }

        // 清除日志
        function clearLogs() {
            logs = [];
            document.getElementById('logContainer').innerHTML = '<div class="log-entry log-info">[清除] 日志已清除</div>';
            addLog('日志已清除', 'info');
        }

        // 导出日志
        function exportLogs() {
            const logText = logs.map(log => log.message).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `timee-debug-logs-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            addLog('✅ 日志已导出', 'success');
        }

        // 页面加载时执行
        window.onload = function() {
            addLog('🚀 实时调试工具已启动', 'info');
            detectAccessStatus();
            testAPIConnection();
            
            // 自动生成测试T-Code
            generateTestTCode();
            
            addTimelineItem('工具启动', '所有功能已就绪，开始诊断...');
        };
    </script>
</body>
</html> 