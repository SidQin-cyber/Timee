<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timee ç”Ÿäº§ç¯å¢ƒè°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .status-item {
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #ccc;
        }
        .status-ok { border-left-color: #28a745; background: #d4edda; }
        .status-error { border-left-color: #dc3545; background: #f8d7da; }
        .status-warning { border-left-color: #ffc107; background: #fff3cd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Timee ç”Ÿäº§ç¯å¢ƒè°ƒè¯•å·¥å…·</h1>
        <p>å½“å‰åŸŸå: <strong id="currentDomain"></strong></p>
        <p>å½“å‰æ—¶é—´: <strong id="currentTime"></strong></p>
    </div>

    <div class="container">
        <h2>ğŸ” ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h2>
        <div class="status-grid" id="statusGrid"></div>
        <button onclick="checkSystemStatus()">åˆ·æ–°çŠ¶æ€</button>
    </div>

    <div class="container">
        <h2>ğŸŒ API è¿æ¥æµ‹è¯•</h2>
        <div>
            <button onclick="testAPIConnection()">æµ‹è¯• API è¿æ¥</button>
            <button onclick="testCORS()">æµ‹è¯• CORS é…ç½®</button>
            <button onclick="testCreateEvent()">æµ‹è¯•åˆ›å»ºæ´»åŠ¨</button>
            <button onclick="testLikeFunction()">æµ‹è¯•ç‚¹èµåŠŸèƒ½</button>
        </div>
        <div class="log" id="apiLog"></div>
    </div>

    <div class="container">
        <h2>âš™ï¸ ç¯å¢ƒé…ç½®æ£€æŸ¥</h2>
        <div>
            <button onclick="checkEnvironmentConfig()">æ£€æŸ¥ç¯å¢ƒé…ç½®</button>
            <button onclick="checkNetworkConfig()">æ£€æŸ¥ç½‘ç»œé…ç½®</button>
        </div>
        <div class="log" id="configLog"></div>
    </div>

    <div class="container">
        <h2>ğŸ”§ é—®é¢˜è¯Šæ–­</h2>
        <div>
            <button onclick="runFullDiagnostic()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
            <button onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        </div>
        <div class="log" id="diagnosticLog"></div>
    </div>

    <script>
        // åˆå§‹åŒ–
        document.getElementById('currentDomain').textContent = window.location.origin;
        document.getElementById('currentTime').textContent = new Date().toLocaleString();

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info', logId = 'apiLog') {
            const logElement = document.getElementById(logId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLogs() {
            const logElements = ['apiLog', 'configLog', 'diagnosticLog'];
            logElements.forEach(id => {
                document.getElementById(id).textContent = '';
            });
        }

        // ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
        async function checkSystemStatus() {
            const statusGrid = document.getElementById('statusGrid');
            statusGrid.innerHTML = '';

            const checks = [
                { name: 'æµè§ˆå™¨æ”¯æŒ', check: () => checkBrowserSupport() },
                { name: 'ç½‘ç»œè¿æ¥', check: () => checkNetworkConnection() },
                { name: 'åŸŸåè§£æ', check: () => checkDomainResolution() },
                { name: 'HTTPS çŠ¶æ€', check: () => checkHTTPS() },
                { name: 'æœ¬åœ°å­˜å‚¨', check: () => checkLocalStorage() },
                { name: 'API å¯è¾¾æ€§', check: () => checkAPIReachability() }
            ];

            for (const check of checks) {
                const result = await check.check();
                const statusItem = document.createElement('div');
                statusItem.className = `status-item status-${result.status}`;
                statusItem.innerHTML = `
                    <strong>${check.name}</strong><br>
                    ${result.message}
                `;
                statusGrid.appendChild(statusItem);
            }
        }

        function checkBrowserSupport() {
            const features = ['fetch', 'Promise', 'localStorage'];
            const missing = features.filter(f => !window[f]);
            return {
                status: missing.length ? 'error' : 'ok',
                message: missing.length ? `ç¼ºå°‘: ${missing.join(', ')}` : 'æ‰€æœ‰åŠŸèƒ½æ”¯æŒ'
            };
        }

        async function checkNetworkConnection() {
            try {
                const response = await fetch('/health', { method: 'GET' });
                return {
                    status: 'ok',
                    message: `è¿æ¥æ­£å¸¸ (${response.status})`
                };
            } catch (error) {
                return {
                    status: 'error',
                    message: `è¿æ¥å¤±è´¥: ${error.message}`
                };
            }
        }

        function checkDomainResolution() {
            const domain = window.location.hostname;
            return {
                status: 'ok',
                message: `åŸŸå: ${domain}`
            };
        }

        function checkHTTPS() {
            const isHTTPS = window.location.protocol === 'https:';
            return {
                status: isHTTPS ? 'ok' : 'warning',
                message: isHTTPS ? 'HTTPS å·²å¯ç”¨' : 'HTTP è¿æ¥ (å»ºè®®ä½¿ç”¨ HTTPS)'
            };
        }

        function checkLocalStorage() {
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                return {
                    status: 'ok',
                    message: 'æœ¬åœ°å­˜å‚¨å¯ç”¨'
                };
            } catch (error) {
                return {
                    status: 'error',
                    message: `æœ¬åœ°å­˜å‚¨ä¸å¯ç”¨: ${error.message}`
                };
            }
        }

        async function checkAPIReachability() {
            try {
                const response = await fetch('/api/health', { method: 'GET' });
                return {
                    status: response.ok ? 'ok' : 'error',
                    message: response.ok ? `API å¯è¾¾ (${response.status})` : `API é”™è¯¯ (${response.status})`
                };
            } catch (error) {
                return {
                    status: 'error',
                    message: `API ä¸å¯è¾¾: ${error.message}`
                };
            }
        }

        // API æµ‹è¯•å‡½æ•°
        async function testAPIConnection() {
            log('å¼€å§‹æµ‹è¯• API è¿æ¥...', 'info');
            
            const endpoints = [
                '/api/health',
                '/api/events',
                '/health'
            ];

            for (const endpoint of endpoints) {
                try {
                    log(`æµ‹è¯•ç«¯ç‚¹: ${endpoint}`, 'info');
                    const response = await fetch(endpoint, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, 
                        response.ok ? 'success' : 'error');
                    
                    if (response.ok) {
                        const data = await response.text();
                        log(`å“åº”æ•°æ®: ${data.substring(0, 200)}...`, 'info');
                    }
                } catch (error) {
                    log(`ç«¯ç‚¹ ${endpoint} æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }

        async function testCORS() {
            log('å¼€å§‹æµ‹è¯• CORS é…ç½®...', 'info');
            
            const testOrigins = [
                window.location.origin,
                'https://timee.group',
                'https://wmxkwzbmhflj.sealoshzh.site'
            ];

            for (const origin of testOrigins) {
                try {
                    log(`æµ‹è¯•æ¥æº: ${origin}`, 'info');
                    const response = await fetch('/api/health', {
                        method: 'OPTIONS',
                        headers: {
                            'Origin': origin,
                            'Access-Control-Request-Method': 'GET',
                            'Access-Control-Request-Headers': 'Content-Type'
                        }
                    });
                    
                    log(`CORS é¢„æ£€å“åº”: ${response.status}`, 
                        response.ok ? 'success' : 'error');
                    
                    // æ£€æŸ¥ CORS å¤´
                    const corsHeaders = [
                        'Access-Control-Allow-Origin',
                        'Access-Control-Allow-Methods',
                        'Access-Control-Allow-Headers'
                    ];
                    
                    corsHeaders.forEach(header => {
                        const value = response.headers.get(header);
                        log(`${header}: ${value || 'æœªè®¾ç½®'}`, value ? 'info' : 'warning');
                    });
                } catch (error) {
                    log(`CORS æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }

        async function testCreateEvent() {
            log('å¼€å§‹æµ‹è¯•åˆ›å»ºæ´»åŠ¨åŠŸèƒ½...', 'info');
            
            const testEvent = {
                title: 'æµ‹è¯•æ´»åŠ¨ - ' + new Date().toISOString(),
                description: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ´»åŠ¨',
                timezone: 'UTC+8',
                startDate: new Date().toISOString().split('T')[0],
                endDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                startTime: '09:00',
                endTime: '17:00',
                eventType: 'group',
                includeTime: true
            };

            try {
                log('å‘é€åˆ›å»ºæ´»åŠ¨è¯·æ±‚...', 'info');
                const response = await fetch('/api/events', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testEvent)
                });

                log(`åˆ›å»ºæ´»åŠ¨å“åº”: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    log(`åˆ›å»ºæˆåŠŸï¼Œæ´»åŠ¨ID: ${data.id}`, 'success');
                    log(`æ´»åŠ¨æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'info');
                } else {
                    const errorData = await response.text();
                    log(`åˆ›å»ºå¤±è´¥: ${errorData}`, 'error');
                }
            } catch (error) {
                log(`åˆ›å»ºæ´»åŠ¨è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testLikeFunction() {
            log('å¼€å§‹æµ‹è¯•ç‚¹èµåŠŸèƒ½...', 'info');
            
            try {
                // é¦–å…ˆè·å–æœ€è¿‘çš„æ´»åŠ¨
                log('è·å–æœ€è¿‘æ´»åŠ¨...', 'info');
                const eventsResponse = await fetch('/api/events');
                
                if (!eventsResponse.ok) {
                    log(`è·å–æ´»åŠ¨å¤±è´¥: ${eventsResponse.status}`, 'error');
                    return;
                }

                const events = await eventsResponse.json();
                log(`è·å–åˆ° ${events.length} ä¸ªæ´»åŠ¨`, 'info');

                if (events.length === 0) {
                    log('æ²¡æœ‰æ´»åŠ¨å¯ä»¥æµ‹è¯•ç‚¹èµåŠŸèƒ½', 'warning');
                    return;
                }

                const testEvent = events[0];
                log(`æµ‹è¯•æ´»åŠ¨: ${testEvent.title} (ID: ${testEvent.id})`, 'info');

                // æµ‹è¯•ç‚¹èµåŠŸèƒ½ï¼ˆè¿™é‡Œéœ€è¦æ ¹æ®ä½ çš„å®é™…ç‚¹èµAPIè°ƒæ•´ï¼‰
                const likeResponse = await fetch(`/api/events/${testEvent.id}/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                log(`ç‚¹èµå“åº”: ${likeResponse.status} ${likeResponse.statusText}`, 
                    likeResponse.ok ? 'success' : 'error');

                if (likeResponse.ok) {
                    const likeData = await likeResponse.json();
                    log(`ç‚¹èµæˆåŠŸ: ${JSON.stringify(likeData, null, 2)}`, 'success');
                } else {
                    const errorData = await likeResponse.text();
                    log(`ç‚¹èµå¤±è´¥: ${errorData}`, 'error');
                }
            } catch (error) {
                log(`ç‚¹èµæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkEnvironmentConfig() {
            log('æ£€æŸ¥ç¯å¢ƒé…ç½®...', 'info', 'configLog');
            
            // æ£€æŸ¥å½“å‰ç¯å¢ƒ
            const env = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                platform: navigator.platform,
                url: window.location.href,
                referrer: document.referrer
            };

            Object.entries(env).forEach(([key, value]) => {
                log(`${key}: ${value}`, 'info', 'configLog');
            });

            // æ£€æŸ¥ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            if (window.process && window.process.env) {
                log('ç¯å¢ƒå˜é‡:', 'info', 'configLog');
                Object.entries(window.process.env).forEach(([key, value]) => {
                    log(`${key}: ${value}`, 'info', 'configLog');
                });
            }
        }

        async function checkNetworkConfig() {
            log('æ£€æŸ¥ç½‘ç»œé…ç½®...', 'info', 'configLog');
            
            // æ£€æŸ¥ç½‘ç»œè¿æ¥
            if ('connection' in navigator) {
                const connection = navigator.connection;
                log(`è¿æ¥ç±»å‹: ${connection.effectiveType}`, 'info', 'configLog');
                log(`ä¸‹è¡Œé€Ÿåº¦: ${connection.downlink} Mbps`, 'info', 'configLog');
                log(`RTT: ${connection.rtt} ms`, 'info', 'configLog');
            }

            // æ£€æŸ¥ DNS è§£æ
            const domains = [
                'timee.group',
                'wmxkwzbmhflj.sealoshzh.site',
                window.location.hostname
            ];

            for (const domain of domains) {
                try {
                    const start = Date.now();
                    await fetch(`https://${domain}/health`, { method: 'HEAD', mode: 'no-cors' });
                    const end = Date.now();
                    log(`${domain}: å¯è¾¾ (${end - start}ms)`, 'success', 'configLog');
                } catch (error) {
                    log(`${domain}: ä¸å¯è¾¾ (${error.message})`, 'error', 'configLog');
                }
            }
        }

        async function runFullDiagnostic() {
            log('å¼€å§‹è¿è¡Œå®Œæ•´è¯Šæ–­...', 'info', 'diagnosticLog');
            
            // è¯Šæ–­æ­¥éª¤
            const diagnosticSteps = [
                { name: 'ç³»ç»ŸçŠ¶æ€', func: checkSystemStatus },
                { name: 'API è¿æ¥', func: testAPIConnection },
                { name: 'CORS é…ç½®', func: testCORS },
                { name: 'ç¯å¢ƒé…ç½®', func: checkEnvironmentConfig },
                { name: 'ç½‘ç»œé…ç½®', func: checkNetworkConfig }
            ];

            for (const step of diagnosticSteps) {
                try {
                    log(`æ‰§è¡Œ: ${step.name}`, 'info', 'diagnosticLog');
                    await step.func();
                    log(`å®Œæˆ: ${step.name}`, 'success', 'diagnosticLog');
                } catch (error) {
                    log(`å¤±è´¥: ${step.name} - ${error.message}`, 'error', 'diagnosticLog');
                }
            }

            log('å®Œæ•´è¯Šæ–­å®Œæˆ', 'success', 'diagnosticLog');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        window.addEventListener('load', () => {
            setTimeout(checkSystemStatus, 1000);
        });
    </script>
</body>
</html> 